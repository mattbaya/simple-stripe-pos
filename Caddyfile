# Caddyfile for automatic HTTPS with Let's Encrypt
{$DOMAIN_NAME:localhost} {
    # Enable automatic HTTPS with Let's Encrypt
    tls {
        # Use Let's Encrypt for automatic SSL certificates
        # Will automatically redirect HTTP to HTTPS
        protocols tls1.2 tls1.3
    }
    
    # Reverse proxy to Flask app
    reverse_proxy app:5000 {
        # Health check
        health_uri /health
        health_interval 30s
        health_timeout 5s
        
        # Headers for proper forwarding
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
    }
    
    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 10MB
            roll_keep 5
        }
        format json
    }
    
    # Security headers
    header {
        # Remove server identification
        -Server
        
        # Security headers
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' cdn.jsdelivr.net; connect-src 'self'"
    }
}

# Redirect any other domains to primary domain (if DOMAIN_NAME is set)
*.{$DOMAIN_NAME:localhost}, {$DOMAIN_NAME:localhost}:443 {
    redir https://{$DOMAIN_NAME}{uri} permanent
}

# Force HTTPS redirect for any HTTP traffic
http:// {
    redir https://{host}{uri} permanent
}